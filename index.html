<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
    ========================================================================================
    CARTIX PREMIUM CLIENT APP - ULTIMATE EDITION
    ========================================================================================
    VERSION: 18.2.1 (PINCH ZOOM + CENTERED SLIDER + SMART NAV)
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    
    <!-- BROWSER THEME COLOR LOGIC -->
    <meta name="theme-color" content="#0A0A0A">
    <meta name="msapplication-navbutton-color" content="#0A0A0A">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>CartiX | Premium Gear</title>
    
    <!-- EXTERNAL DEPENDENCIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Standard Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        /* ---------------------------------------------------------
        1. TYPOGRAPHY & ROOT VARIABLES 
        --------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --accent-yellow: #FFC700;
            --surface-dark: #0A0A0A;
            --surface-card: #141414;
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-smarty: 'Poppins', sans-serif;
            --transition-smooth: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            
            /* --- LIQUID GLASS VARIABLES --- */
            --shadow-offset: 0;
            --shadow-blur: 20px;
            --shadow-spread: -7px;
            --shadow-color: rgba(255, 255, 255, 0.5); 
            
            --tint-color: 20, 20, 20; 
            --tint-opacity: 0.3;
            
            --frost-blur: 2px;
            
            --noise-frequency: 0.008;
            --distortion-strength: 700;
            
            --outer-shadow-blur: 24px;

            -webkit-user-select: none;
            -ms-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* ---------------------------------------------------------
        2. BASE STYLING & RESET
        --------------------------------------------------------- */
        html {
            background-color: var(--surface-dark);
            height: 100%;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--surface-dark);
            color: white;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            min-height: 100%;
        }

        /* ---------------------------------------------------------
        3. LOADING OVERLAY
        --------------------------------------------------------- */
        #loadingArrangement {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            display: none; 
        }

        #loadingArrangement lottie-player {
            width: 113px;
            height: 113px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #0A0A0A;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden-loader {
            opacity: 0;
            pointer-events: none;
        }

        .loading-overlay lottie-player {
            width: 113px;
            height: 113px;
        }

        /* ---------------------------------------------------------
        4. GENERAL UI STYLES
        --------------------------------------------------------- */
        .hero-container {
            border-radius: 18px; 
            overflow: hidden;
            height: auto;
            width: 100%;
            box-shadow: 0 40px 100px -20px rgba(0,0,0,0.8);
        }

        .slider-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: var(--transition-smooth);
        }
        
        .slider-dot.active {
            width: 20px;
            border-radius: 10px;
            background: var(--accent-yellow);
        }

        /* ---------------------------------------------------------
        LIQUID GLASS DOCK
        --------------------------------------------------------- */
        .liquid-glass-dock {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 440px;
            height: 72px;
            border-radius: 28px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            
            background: transparent;
            border: none;
            backdrop-filter: none;
            
            isolation: isolate;
            box-shadow: 0px 6px var(--outer-shadow-blur) rgba(0, 0, 0, 0.4);
            transition: transform 0.4s ease;
        }

        .liquid-glass-dock::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            border-radius: 28px;
            box-shadow: inset var(--shadow-offset) var(--shadow-offset) var(--shadow-blur) var(--shadow-spread) var(--shadow-color);
            background-color: rgba(var(--tint-color), var(--tint-opacity));
            pointer-events: none;
        }

        .liquid-glass-dock::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: -1;
            border-radius: 28px;
            backdrop-filter: blur(var(--frost-blur));
            filter: url(#glass-distortion);
            isolation: isolate;
            -webkit-backdrop-filter: blur(var(--frost-blur));
            -webkit-filter: url("#glass-distortion");
            pointer-events: none;
        }

        .dock-item {
            color: #71717A;
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10; 
        }

        .dock-item.active {
            color: var(--accent-yellow);
            transform: translateY(-2px);
        }

        .dock-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--accent-yellow);
        }

        /* Category Buttons */
        .cat-btn {
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            box-sizing: border-box;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ---------------------------------------------------------
        INSPECTION SLIDER (FIXED CENTERING)
        --------------------------------------------------------- */
        #inspectSlider {
            display: flex;
            flex-wrap: nowrap;
            height: 100%; /* Matches parent fixed height */
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            align-items: center;
        }

        .inspect-slide {
            flex: 0 0 100%;
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            box-sizing: border-box;
        }

        .inspect-slide img {
            width: 100%;
            height: auto;
            max-height: 85%; /* Ensure it fits nicely within the 55vh container */
            object-fit: contain;
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5));
            border-radius: 24px;
            transition: transform 0.3s ease;
        }

        /* Slider Dots Background Card */
        #inspectSliderDots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.25); /* High transparency black */
            backdrop-filter: blur(12px); /* Blur effect */
            padding: 8px 14px;
            border-radius: 99px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .inspect-card {
            animation: slideUpView 0.7s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUpView {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ---------------------------------------------------------
        ZOOM OVERLAY STYLES
        --------------------------------------------------------- */
        #zoomOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            touch-action: none;
            overflow: hidden;
        }
        
        #zoomOverlay.active {
            display: flex;
            opacity: 1;
        }

        #zoomImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: center;
            will-change: transform;
            cursor: grab;
            transition: transform 0.1s linear; 
        }

        .zoom-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10000;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        /* Size Chips */
        .size-chip {
            padding: 10px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: #71717A;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 48px;
            text-align: center;
        }

        .size-chip.selected {
            background: var(--accent-yellow);
            color: black;
            border-color: var(--accent-yellow);
            box-shadow: 0 4px 12px rgba(255, 199, 0, 0.2);
            transform: translateY(-2px);
        }

        /* Animations & Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page-transition {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .fade-in-up {
            animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Skeleton Loader */
        .premium-skeleton {
            position: relative;
            overflow: hidden;
            background: #181818;
        }
        
        .premium-skeleton::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(
                105deg,
                transparent 0%,
                rgba(255, 255, 255, 0.05) 40%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 60%,
                transparent 100%
            );
            transform: translateX(-100%);
            animation: premiumShimmer 1.5s infinite cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5;
        }

        @keyframes premiumShimmer {
            0% { transform: translateX(-150%) skewX(-20deg); }
            100% { transform: translateX(200%) skewX(-20deg); }
        }

        /* Smarty AI */
        .smarty-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 10;
        }

        .smarty-chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .smarty-message {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            font-family: var(--font-smarty);
            font-size: 0.92rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .smarty-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(255, 199, 0, 0.15), rgba(255, 199, 0, 0.05));
            border: 1px solid rgba(255, 199, 0, 0.2);
            border-bottom-right-radius: 4px;
            color: #fff;
        }

        .smarty-message.bot {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 4px;
            color: #e0e0e0;
        }

        .smarty-input-dock {
            flex-shrink: 0;
            background: rgba(20,20,20,0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 15px 20px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .smarty-input-field {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-family: var(--font-smarty);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .smarty-input-field:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 199, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(255, 199, 0, 0.05);
        }

        .smarty-send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-yellow);
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
        }

        .smarty-send-btn:active { transform: scale(0.9); }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 199, 0, 0.05);
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
            z-index: 0;
            filter: blur(40px);
        }
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0.2; }
            33% { transform: translate(30px, -50px) rotate(10deg); opacity: 0.4; }
            66% { transform: translate(-20px, 20px) rotate(-10deg); opacity: 0.2; }
            100% { transform: translate(0, 0) rotate(0deg); opacity: 0.2; }
        }

        /* Tracking & Select UI */
        .tracking-step .dot { transition: all 0.5s ease; }
        
        .custom-select-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            background: #121212;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            margin-top: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .custom-select-options.open { display: block; }
        .custom-option {
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .custom-option:hover { background: rgba(255,255,255,0.05); color: var(--accent-yellow); }

        /* Search Header Logic */
        #headerWrapper { transition: var(--transition-smooth); gap: 2rem; }
        #brandLogo { transition: var(--transition-smooth); transform-origin: left center; }
        #searchIcon { display: block; transition: opacity 0.3s; }
        #searchCloseBtn { display: none; transition: opacity 0.3s; }

        body.is-searching #headerWrapper { gap: 0 !important; }
        body.is-searching #brandLogo { width: 0; opacity: 0; margin: 0; transform: scale(0.9) translateX(-20px); pointer-events: none; }
        body.is-searching #searchOverlay { display: block; opacity: 1; }
        body.is-searching #searchSuggestions { display: block; }
        body.is-searching #searchIcon { display: none; }
        body.is-searching #searchCloseBtn { display: block; }
        
        /* Auth Styles */
        #authPage {
            background-color: #0A0A0A;
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 199, 0, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 199, 0, 0.05) 0px, transparent 50%);
        }
        .auth-input {
            width: 100%;
            background: #121212;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px 20px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        .auth-input:focus {
            border-color: rgba(255, 199, 0, 0.5);
            background: #161616;
        }

        /* Filter Chips */
        .filter-chip {
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: #52525B;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .filter-chip.active {
            background: var(--accent-yellow);
            color: black;
            border-color: var(--accent-yellow);
        }
    </style>
</head>
<body class="bg-[#0A0A0A]" id="mainBody">

    <!-- 
    ========================================================================================
    SVG FILTER DEFINITION FOR LIQUID GLASS EFFECT
    ========================================================================================
    -->
    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute; overflow:hidden">
        <defs>
          <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
            <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise" />
            <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
            <feDisplacementMap in="SourceGraphic" in2="blurred" scale="77" xChannelSelector="R" yChannelSelector="G" />
          </filter>
        </defs>
    </svg>

    <!-- 
    ========================================================================================
    LOADING ARRANGEMENT (Initial / Static) - 2.5x SIZE
    ========================================================================================
    -->
    <div id="loadingArrangement">
        <lottie-player
            src="https://ik.imagekit.io/lssafvcmr/CartiX/Banner/Ripple%20loading%20animation.json"
            background="transparent"
            speed="1"
            style="width: 113px; height: 113px;"
            loop
            autoplay
        ></lottie-player>
    </div>

    <!-- 
    ========================================================================================
    AUTHENTICATION OVERLAY (LOGIN / SIGNUP)
    ========================================================================================
    -->
    <div id="authPage" class="fixed inset-0 z-[5000] flex flex-col items-center justify-center p-6 transition-all duration-500">
        
        <!-- Animated Brand -->
        <div class="mb-12 text-center">
            <div class="text-5xl font-black tracking-tighter select-none mb-2">
                <span class="text-yellow-400">Carti</span><span class="text-white">X</span>
            </div>
            <p class="text-[10px] text-zinc-500 uppercase tracking-[0.5em] font-bold">Ultimate Edition</p>
        </div>

        <!-- Login Container -->
        <div id="loginContainer" class="w-full max-w-md bg-[#121212]/50 backdrop-blur-xl border border-white/5 p-8 rounded-[32px] shadow-2xl">
            <h2 class="text-2xl font-black italic uppercase tracking-tighter mb-2 text-white">Welcome Back</h2>
            <p class="text-xs text-zinc-500 mb-8">Enter your credentials to access your gear.</p>
            
            <form id="loginForm" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Mobile Number</label>
                    <div class="relative">
                        <input type="tel" id="loginMobile" maxlength="10" placeholder="9876543210" class="auth-input pl-12" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold">+91</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Password</label>
                    <input type="password" id="loginPass" placeholder="••••••••" class="auth-input" required>
                </div>
                
                <button type="submit" class="w-full bg-yellow-400 text-black font-black py-4 rounded-xl uppercase text-xs tracking-[0.2em] shadow-lg shadow-yellow-400/10 hover:scale-[1.02] active:scale-95 transition-all mt-4">Login Securely</button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-xs text-zinc-500">New to CartiX? <button onclick="toggleAuth('signup')" class="text-yellow-400 font-bold hover:underline ml-1">Create Account</button></p>
            </div>
        </div>

        <!-- Signup Container (Hidden Initially) -->
        <div id="signupContainer" class="hidden w-full max-w-md bg-[#121212]/50 backdrop-blur-xl border border-white/5 p-8 rounded-[32px] shadow-2xl">
            <h2 class="text-2xl font-black italic uppercase tracking-tighter mb-2 text-white">Join The Elite</h2>
            <p class="text-xs text-zinc-500 mb-8">Create your profile to start ordering.</p>
            
            <form id="signupForm" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Full Name</label>
                    <input type="text" id="regName" placeholder="Name" class="auth-input" required>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Mobile Number</label>
                    <div class="relative">
                        <input type="tel" id="regMobile" maxlength="10" placeholder="9876543210" class="auth-input pl-12" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold">+91</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Password</label>
                        <input type="password" id="regPass" placeholder="Min 8 chars" class="auth-input" required minlength="8">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest pl-2">Confirm</label>
                        <input type="password" id="regConfirmPass" placeholder="Repeat" class="auth-input" required minlength="8">
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-white text-black font-black py-4 rounded-xl uppercase text-xs tracking-[0.2em] shadow-lg hover:bg-zinc-200 active:scale-95 transition-all mt-4">Create Account</button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-xs text-zinc-500">Already a member? <button onclick="toggleAuth('login')" class="text-yellow-400 font-bold hover:underline ml-1">Login</button></p>
            </div>
        </div>
    </div>

    <!-- Background Blur Overlay -->
    <div id="searchOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[90] hidden transition-opacity duration-500"></div>

    <!-- 
    ========================================================================================
    FULL SCREEN ZOOM OVERLAY
    ========================================================================================
    -->
    <div id="zoomOverlay">
        <div class="zoom-close" onclick="closeZoom()">
            <i data-lucide="x" class="w-6 h-6"></i>
        </div>
        <img id="zoomImage" src="" alt="Zoomed View">
        <div class="absolute bottom-10 left-0 w-full text-center pointer-events-none">
            <p class="text-[10px] text-white/50 uppercase tracking-widest animate-pulse">Pinch to Zoom • Drag to Pan</p>
        </div>
    </div>

    <!-- 
    ========================================================================================
    HEADER & NAVIGATION 
    ========================================================================================
    -->
    <header class="fixed top-0 w-full z-[100] bg-[#0A0A0ABF] backdrop-blur-2xl border-b border-white/5 transition-all" id="mainHeader">
        <div class="max-w-[1600px] mx-auto px-6 h-20 relative flex items-center justify-start" id="headerWrapper">
            
            <!-- Brand Logo -->
            <div id="brandLogo" class="text-2xl font-black tracking-tighter cursor-pointer select-none overflow-hidden whitespace-nowrap w-auto shrink-0" onclick="showPage('home')">
                <span class="text-yellow-400">Carti</span><span class="text-white">X</span>
            </div>

            <!-- Search Bar -->
            <div id="searchContainer" class="relative z-10 flex-1 transition-all duration-500 ease-out w-32 md:w-64">
                <input type="text" id="searchInput" placeholder="Search..." autocomplete="off"
                    class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-3.5 text-xs font-medium focus:outline-none focus:border-yellow-400/50 transition-all placeholder:text-zinc-600 focus:placeholder:text-zinc-500 text-left focus:bg-[#181818]">
                
                <i id="searchIcon" data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500 pointer-events-none"></i>
                <i id="searchCloseBtn" data-lucide="x" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400 cursor-pointer hover:text-white transition-colors" onclick="closeSearch()"></i>
                
                <div id="searchSuggestions" class="absolute top-full right-0 w-full bg-[#121212] border border-white/10 rounded-2xl mt-3 p-2 hidden shadow-2xl z-[110] origin-top">
                    <div id="suggestionList" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- 
    ========================================================================================
    MAIN CONTENT AREA
    ========================================================================================
    -->
    <main class="pt-28 pb-32 transition-all duration-300 min-h-screen" id="mainContent">
        
        <!-- [HOME PAGE] -->
        <div id="homePage" class="max-w-[1400px] mx-auto px-6 page-transition">
            <!-- Hero Spotlight -->
            <section class="mb-16 relative">
                <div class="hero-container bg-[#111] border border-white/5 group premium-skeleton" id="heroContainer">
                    <div id="heroSlider" class="flex h-full transition-transform duration-1000 ease-in-out"></div>
                </div>
                <div id="heroDots" class="absolute -bottom-8 left-1/2 -translate-x-1/2 flex gap-3"></div>
            </section>

            <!-- Horizontal Categories -->
            <section class="mb-12 flex gap-3 overflow-x-auto no-scrollbar py-2" id="categoryTabs">
                <button onclick="filterCategory('All')" class="cat-btn active px-9 py-3.5 rounded-2xl border border-white/5 text-[10px] font-black uppercase bg-yellow-400 text-black transition-all shrink-0 border border-[#FFC700]">All</button>
                <button onclick="filterCategory('Home Decor')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Home Decor</button>
                <button onclick="filterCategory('Lifestyle')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Lifestyle</button>
                <button onclick="filterCategory('Accessories')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Accessories</button>
                <button onclick="filterCategory('Electronics')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Electronics</button>
                <button onclick="filterCategory('Gadgets')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Gadgets</button>
                <button onclick="filterCategory('Fitness')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Fitness</button>
                <button onclick="filterCategory('Skincare')" class="cat-btn px-9 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all shrink-0 border border-white/10 bg-transparent">Skincare</button>
            </section>

            <!-- Core Product Matrix -->
            <div id="productGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10 transition-all duration-300">
                <!-- Skeleton Loading State -->
                <div class="col-span-full py-20 text-center text-zinc-600 text-xs tracking-widest uppercase animate-pulse">Syncing with Cloud...</div>
            </div>
        </div>

        <!-- [SEARCH RESULTS PAGE - LIST VIEW] -->
        <div id="searchPage" class="hidden max-w-[1400px] mx-auto px-6 page-transition">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-black italic uppercase tracking-tighter text-white">Results For "<span id="searchQueryDisplay" class="text-yellow-400">...</span>"</h2>
                <button onclick="showPage('home')" class="text-[10px] font-bold uppercase text-zinc-500 hover:text-white">Clear</button>
            </div>

            <!-- Filters -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-6 mb-4">
                <button onclick="applyFilter('price', 'low')" class="filter-chip" id="filter-price-low">Price: Low to High</button>
                <button onclick="applyFilter('price', 'high')" class="filter-chip" id="filter-price-high">Price: High to Low</button>
                <button onclick="applyFilter('rating', 4.5)" class="filter-chip" id="filter-rating-45">4.5+ ★</button>
                <button onclick="applyFilter('rating', 4)" class="filter-chip" id="filter-rating-4">4+ ★</button>
                <button onclick="applyFilter('rating', 3)" class="filter-chip" id="filter-rating-3">3+ ★</button>
            </div>

            <!-- Search List Container -->
            <div id="searchResultList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Items Injected JS -->
            </div>
        </div>

        <!-- [LIKES PAGE] -->
        <div id="likesPage" class="hidden max-w-[1400px] mx-auto px-6 page-transition">
            <div class="flex items-center justify-between mb-12">
                <h2 class="text-xl font-black italic uppercase tracking-tighter text-white/40">Wishlist</h2>
                <span class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Saved Items</span>
            </div>
            <div id="wishlistGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </div>

        <!-- [CART PAGE] -->
        <div id="cartPage" class="hidden max-w-[1400px] mx-auto px-6 page-transition">
            <div class="flex items-center justify-between mb-12">
                <h2 class="text-xl font-black italic uppercase tracking-tighter text-white/40">My Bag</h2>
                <div class="flex items-center gap-2">
                    <i data-lucide="truck" class="w-4 h-4 text-yellow-400"></i>
                    <span class="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Free Shipping Active</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <div id="cartItemsList" class="lg:col-span-2 space-y-4"></div>
                
                <div class="bg-[#121212] border border-white/5 p-8 rounded-[32px] h-fit sticky top-28">
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 mb-8 tracking-[0.2em]">Order Summary</h3>
                    <div class="space-y-4 mb-8">
                        <div class="flex justify-between text-xs font-bold text-zinc-500">
                            <span>Subtotal</span>
                            <span id="subTotalVal">₹0</span>
                        </div>
                        <div class="flex justify-between text-xs font-bold text-zinc-500">
                            <span>Platform Fee</span>
                            <span>₹0.00</span>
                        </div>
                        <div class="pt-6 border-t border-white/5 flex justify-between text-2xl font-black">
                            <span>Total</span>
                            <span id="totalVal" class="text-yellow-400">₹0</span>
                        </div>
                    </div>
                    <button onclick="checkout()" class="w-full bg-yellow-400 text-black font-black py-5 rounded-2xl uppercase text-[11px] tracking-[0.2em] shadow-xl shadow-yellow-400/5 hover:translate-y-[-2px] active:scale-95 transition-all">Proceed to Checkout</button>
                    <p class="text-[9px] text-zinc-600 mt-6 text-center leading-relaxed">Secure payment processed via Razorpay encrypted gateway.</p>
                </div>
            </div>
        </div>

        <!-- [PROFILE PAGE] -->
        <div id="profilePage" class="hidden max-w-2xl mx-auto px-6 page-transition">
            <div class="flex flex-col items-center mb-12">
                <div class="w-28 h-28 rounded-[36px] bg-yellow-400 flex items-center justify-center mb-6 shadow-2xl shadow-yellow-400/20">
                    <i data-lucide="user" class="w-12 h-12 text-black"></i>
                </div>
                <div class="text-center">
                    <span class="text-yellow-400 text-[9px] font-black uppercase tracking-[0.4em] mb-2 block">Be an Inspiration</span>
                    <h2 id="profileName" class="text-2xl font-black italic uppercase tracking-tighter">Guest User</h2>
                    <p id="profileMobile" class="text-zinc-600 text-xs mt-1">+91 XXXXX XXXXX</p>
                </div>
            </div>
            
            <div class="grid gap-3">
                <div onclick="showPage('orderHistory')" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="package" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">Order History</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                 <!-- CHANGE NAME BUTTON -->
                 <div onclick="openChangeName()" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="edit-3" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">Change Name</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                <div onclick="showPaymentModal()" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="credit-card" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">Payment Methods</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                <div onclick="showShippingPage()" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">Shipping Addresses</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                <div onclick="showPage('smarty')" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="bot" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">FAQs & Help (Smarty)</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                <div onclick="showPage('security')" class="group p-6 bg-[#121212] border border-white/5 rounded-[28px] flex items-center justify-between hover:bg-white/5 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-400">
                            <i data-lucide="shield-check" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm">Security & Privacy</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-zinc-800 group-hover:text-yellow-400 transition-colors"></i>
                </div>

                <div onclick="logout()" class="mt-6 p-6 bg-red-500/5 border border-red-500/10 rounded-[28px] flex items-center justify-between hover:bg-red-500/10 transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div class="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center text-red-500">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </div>
                        <span class="font-bold text-sm text-red-500">Logout Account</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- [NEW ADDRESS PAGE] -->
        <div id="shippingPage" class="hidden max-w-2xl mx-auto px-6 page-transition">
            <div class="flex items-center gap-4 mb-8">
                 <button onclick="showPage('profile')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-yellow-400 hover:text-black transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <h2 class="text-xl font-black italic uppercase tracking-tighter">Add Address</h2>
            </div>

            <form id="addressForm" class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Full Name</label>
                    <input type="text" id="addrName" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" placeholder="Name" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Mobile Number</label>
                        <div class="flex">
                             <span class="bg-white/5 border border-white/10 rounded-l-2xl px-4 py-4 text-sm text-zinc-400 border-r-0 cursor-not-allowed">+91</span>
                             <input type="tel" id="addrMobile" maxlength="10" class="w-full bg-[#121212] border border-white/10 rounded-r-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Alt Mobile (Optional)</label>
                        <input type="tel" id="addrAltMobile" maxlength="10" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Flat, House no., Building</label>
                    <input type="text" id="addrHouse" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Area, Sector, Locality</label>
                    <input type="text" id="addrArea" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">Pincode</label>
                        <input type="text" id="addrPincode" maxlength="6" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required placeholder="495001" oninput="handlePincode(this.value)">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">City</label>
                        <input type="text" id="addrCity" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">District</label>
                        <input type="text" id="addrDistrict" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none" required>
                    </div>
                    <div class="space-y-2 relative">
                        <label class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">State</label>
                        <div id="customStateSelect" class="w-full bg-[#121212] border border-white/10 rounded-2xl px-5 py-4 text-sm text-zinc-400 cursor-pointer flex justify-between items-center" onclick="toggleStateDropdown()">
                            <span id="selectedState">Select State</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                        <div id="stateOptions" class="custom-select-options"></div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-yellow-400 text-black font-black py-5 rounded-[24px] uppercase text-xs tracking-[0.2em] shadow-xl shadow-yellow-400/5 hover:scale-[1.01] active:scale-95 transition-all mt-8">Save Address</button>
            </form>
        </div>

        <!-- [ORDER HISTORY PAGE] -->
        <div id="orderHistoryPage" class="hidden max-w-2xl mx-auto px-6 page-transition">
            <div class="flex items-center gap-4 mb-8">
                <button onclick="showPage('profile')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-yellow-400 hover:text-black transition-colors">
                   <i data-lucide="arrow-left" class="w-5 h-5"></i>
               </button>
               <h2 class="text-xl font-black italic uppercase tracking-tighter">My Orders</h2>
           </div>

           <div class="flex gap-4 mb-8">
               <button onclick="filterOrders('active')" id="tabActive" class="flex-1 py-3 rounded-xl bg-yellow-400 text-black text-xs font-black uppercase">Ordered (Active)</button>
               <button onclick="filterOrders('completed')" id="tabCompleted" class="flex-1 py-3 rounded-xl bg-white/5 text-zinc-500 text-xs font-black uppercase">Completed</button>
           </div>

           <div class="relative mb-6">
               <input type="text" id="orderSearch" placeholder="Search orders by ID..." class="w-full bg-[#121212] border border-white/10 rounded-2xl px-12 py-3 text-xs text-white focus:outline-none focus:border-yellow-400/30" oninput="renderOrders()">
               <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-600"></i>
           </div>

           <div id="ordersList" class="space-y-4"></div>
        </div>

        <!-- [ORDER DETAIL PAGE] -->
        <div id="orderDetailPage" class="hidden max-w-2xl mx-auto px-6 page-transition pb-20">
            <div class="flex items-center gap-4 mb-8">
                <button onclick="showPage('orderHistory')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-yellow-400 hover:text-black transition-colors">
                   <i data-lucide="arrow-left" class="w-5 h-5"></i>
               </button>
               <h2 class="text-xl font-black italic uppercase tracking-tighter">Track Order</h2>
           </div>
           <div id="orderDetailContent"></div>
        </div>

        <!-- 
        ========================================================================================
        SMARTY UI
        ========================================================================================
        -->
        <div id="smartyPage" class="hidden w-full h-full fixed top-0 left-0 bg-[#0A0A0A] z-[5000]">
            
            <!-- Yellow Bubbles -->
            <div class="bubble" style="width: 250px; height: 250px; left: 10%; top: 20%; background: radial-gradient(circle, rgba(255, 199, 0, 0.15), transparent);"></div>
            <div class="bubble" style="width: 350px; height: 350px; left: 60%; top: 60%; background: radial-gradient(circle, rgba(255, 199, 0, 0.1), transparent); animation-delay: -5s;"></div>
            
            <div class="smarty-container">
                
                <!-- Smarty Header -->
                <div class="relative z-10 flex items-center justify-between px-6 py-4 bg-white/5 backdrop-blur-xl border-b border-white/5">
                    <button onclick="showPage('profile')" class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center text-white hover:bg-yellow-400 hover:text-black transition-all">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <div class="text-center">
                        <h2 class="text-white font-bold text-sm font-[Poppins]">Smarty AI</h2>
                        <div class="flex items-center justify-center gap-1.5 mt-0.5">
                            <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full animate-pulse"></span>
                            <span class="text-[9px] text-white/50 uppercase tracking-widest font-bold">Online</span>
                        </div>
                    </div>
                    <div class="w-12"></div>
                </div>

                <!-- Chat Messages Area -->
                <div id="chatMessages" class="smarty-chat-area no-scrollbar">
                    <div class="smarty-message bot">
                        Hello! I'm Smarty, your personal shopping assistant. How can I help you today?
                    </div>
                </div>
                
                <!-- Quick Options -->
                <div class="px-5 py-3 z-20 flex gap-2 overflow-x-auto no-scrollbar mask-gradient-right">
                    <div id="chatControls" class="flex gap-2">
                        <!-- Chips injected via JS -->
                    </div>
                </div>

                <!-- Input Dock -->
                <div class="smarty-input-dock">
                    <div class="relative flex-1">
                        <input type="text" id="smartyInput" class="smarty-input-field w-full" placeholder="Ask anything..." autocomplete="off">
                    </div>
                    <button class="smarty-send-btn" onclick="handleSmartyInput()">
                        <i data-lucide="send" class="w-5 h-5 ml-0.5 mt-0.5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 
        ========================================================================================
        EXPANDED PRIVACY & SECURITY PAGE
        ========================================================================================
        -->
        <div id="securityPage" class="hidden max-w-2xl mx-auto px-6 page-transition pb-32">
            
            <!-- Header -->
            <div class="flex items-center gap-4 mb-8">
                <button onclick="showPage('profile')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center hover:bg-yellow-400 hover:text-black transition-colors">
                   <i data-lucide="arrow-left" class="w-5 h-5"></i>
               </button>
               <h2 class="text-xl font-black italic uppercase tracking-tighter">Security & Privacy</h2>
            </div>
           
            <!-- Security Status Card -->
            <div class="bg-gradient-to-br from-[#1A1A1A] to-[#0A0A0A] border border-white/10 rounded-[28px] p-6 mb-8 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-400/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/3"></div>
                <div class="flex items-start justify-between mb-6 relative z-10">
                    <div>
                        <p class="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-1">Status</p>
                        <h3 class="text-xl font-bold text-white">Connection Secure</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center text-green-500 border border-green-500/20">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                    </div>
                </div>
                <div class="space-y-3 relative z-10">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-zinc-400">Encryption Standard</span>
                        <span class="text-white font-mono">AES-256-GCM</span>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-zinc-400">Payment Gateway</span>
                        <div class="flex items-center gap-1.5 text-white">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            Razorpay (PCI-DSS)
                        </div>
                    </div>
                     <div class="flex items-center justify-between text-xs">
                        <span class="text-zinc-400">Session ID</span>
                        <span class="text-zinc-600 font-mono">****-****-SECURE</span>
                    </div>
                </div>
            </div>

            <!-- Legal Accordion -->
            <div class="mb-10">
                <h3 class="text-sm font-black uppercase text-zinc-500 tracking-widest mb-4 px-2">Legal & Data</h3>
                <div class="bg-[#121212] border border-white/5 rounded-[24px] overflow-hidden">
                    
                    <!-- Item 1 -->
                    <div class="border-b border-white/5">
                        <button onclick="togglePrivacy('sec1')" class="w-full flex items-center justify-between p-5 hover:bg-white/5 transition-colors">
                            <span class="text-xs font-bold text-white">1. Data Collection</span>
                            <i data-lucide="chevron-down" id="icon-sec1" class="w-4 h-4 text-zinc-500 transition-transform"></i>
                        </button>
                        <div id="sec1" class="hidden px-5 pb-5 text-[10px] text-zinc-400 leading-relaxed text-justify border-t border-white/5 bg-black/20">
                            We collect personal information that you provide to us (Name, Mobile Number, Shipping Address) to fulfill orders. We also automatically collect device information (IP address, browser type) to optimize our application performance and prevent fraud.
                        </div>
                    </div>

                    <!-- Item 2 -->
                    <div class="border-b border-white/5">
                        <button onclick="togglePrivacy('sec2')" class="w-full flex items-center justify-between p-5 hover:bg-white/5 transition-colors">
                            <span class="text-xs font-bold text-white">2. Payment Security</span>
                            <i data-lucide="chevron-down" id="icon-sec2" class="w-4 h-4 text-zinc-500 transition-transform"></i>
                        </button>
                        <div id="sec2" class="hidden px-5 pb-5 text-[10px] text-zinc-400 leading-relaxed text-justify border-t border-white/5 bg-black/20">
                            CartiX does not store your credit/debit card information. All payments are processed via Razorpay, a PCI-DSS compliant payment gateway. Your transaction data is encrypted using industry-standard protocols during transmission.
                        </div>
                    </div>

                    <!-- Item 3 -->
                    <div class="border-b border-white/5">
                        <button onclick="togglePrivacy('sec3')" class="w-full flex items-center justify-between p-5 hover:bg-white/5 transition-colors">
                            <span class="text-xs font-bold text-white">3. Third-Party Sharing</span>
                            <i data-lucide="chevron-down" id="icon-sec3" class="w-4 h-4 text-zinc-500 transition-transform"></i>
                        </button>
                        <div id="sec3" class="hidden px-5 pb-5 text-[10px] text-zinc-400 leading-relaxed text-justify border-t border-white/5 bg-black/20">
                            We do not sell your personal data. We only share necessary data with logistics partners (delivery services) and payment processors to complete your transaction. Analytics data is anonymized.
                        </div>
                    </div>

                    <!-- Item 4 -->
                    <div class="border-b border-white/5">
                        <button onclick="togglePrivacy('sec4')" class="w-full flex items-center justify-between p-5 hover:bg-white/5 transition-colors">
                            <span class="text-xs font-bold text-white">4. User Rights</span>
                            <i data-lucide="chevron-down" id="icon-sec4" class="w-4 h-4 text-zinc-500 transition-transform"></i>
                        </button>
                        <div id="sec4" class="hidden px-5 pb-5 text-[10px] text-zinc-400 leading-relaxed text-justify border-t border-white/5 bg-black/20">
                            You have the right to access, correct, or delete your personal data. You can update your profile directly in the app. To request full data erasure, please use the 'Delete Account' option in the Danger Zone below.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div>
                <h3 class="text-sm font-black uppercase text-zinc-500 tracking-widest mb-4 px-2">Data Actions</h3>
                <div class="space-y-3">
                    <button class="w-full p-4 bg-[#121212] border border-white/5 rounded-2xl flex items-center justify-between hover:bg-white/5 transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="download" class="w-4 h-4 text-white"></i>
                            <span class="text-xs font-bold text-white">Request Data Archive</span>
                        </div>
                    </button>
                    
                    <button onclick="logout()" class="w-full p-4 bg-red-500/5 border border-red-500/10 rounded-2xl flex items-center justify-between hover:bg-red-500/10 transition-colors group">
                        <div class="flex items-center gap-3">
                            <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                            <span class="text-xs font-bold text-red-500 group-hover:text-red-400">Delete Account & Data</span>
                        </div>
                    </button>
                </div>
                <p class="text-[9px] text-zinc-600 text-center mt-8 uppercase tracking-widest">CartiX Secure v18.2.1</p>
            </div>
        </div>

    </main>

    <!-- 
    ========================================================================================
    FLOATING NAVIGATION DOCK (LIQUID GLASS)
    ========================================================================================
    -->
    <nav class="liquid-glass-dock" id="navDock">
        <button onclick="showPage('home')" class="dock-item active" data-page="home">
            <i data-lucide="home" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('likes')" class="dock-item" data-page="likes">
            <i data-lucide="heart" class="w-6 h-6"></i>
        </button>
        <button onclick="showPage('cart')" class="dock-item" data-page="cart">
            <div class="relative">
                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                <span id="cartCount" class="absolute -top-1.5 -right-1.5 bg-yellow-400 text-black text-[9px] font-black h-4 w-4 rounded-full flex items-center justify-center border border-[#0A0A0A]">0</span>
            </div>
        </button>
        <button onclick="showPage('profile')" class="dock-item" data-page="profile">
            <i data-lucide="user" class="w-6 h-6"></i>
        </button>
    </nav>

    <!-- 
    ========================================================================================
    PRODUCT INSPECTION SYSTEM (OVERLAY)
    ========================================================================================
    -->
    <div id="inspectOverlay" class="fixed inset-0 z-[2000] hidden bg-black flex items-center justify-center overflow-hidden">
        <div class="inspect-card w-full h-full flex flex-col md:flex-row relative bg-[#0A0A0A] overflow-y-auto md:overflow-hidden">
            <button onclick="closeInspect()" class="fixed top-6 right-6 z-[2200] w-12 h-12 bg-black/80 backdrop-blur-2xl border border-white/10 rounded-full flex items-center justify-center hover:bg-yellow-400 hover:text-black transition-all group">
                <i data-lucide="x" class="w-5 h-5 group-hover:scale-90 transition-transform"></i>
            </button>
            
            <!-- FIXED CENTER SLIDER WRAPPER (MOBILE 55vh, DESKTOP FULL) -->
            <div class="w-full md:w-[60%] h-[55vh] md:h-full shrink-0 bg-[#050505] relative group overflow-hidden border-b md:border-b-0 md:border-r border-white/5 flex items-center justify-center">
                <div id="inspectSlider"></div>
                
                <!-- NAVIGATION BUTTONS (Now correctly centered due to parent flex) -->
                <button onclick="moveInspectSlider(-1)" class="absolute left-6 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white opacity-80 hover:opacity-100 transition-all hover:bg-yellow-400 hover:text-black z-20 border border-white/5">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <button onclick="moveInspectSlider(1)" class="absolute right-6 top-1/2 -translate-y-1/2 w-12 h-12 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white opacity-80 hover:opacity-100 transition-all hover:bg-yellow-400 hover:text-black z-20 border border-white/5">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
                
                <div id="inspectSliderDots"></div>
            </div>

            <div class="w-full md:w-[40%] min-h-[45vh] md:h-full p-6 md:p-12 flex flex-col bg-[#0A0A0A] overflow-y-visible md:overflow-y-auto no-scrollbar pb-24 md:pb-8">
                <div class="mb-auto">
                    <span id="inspectCat" class="text-[10px] font-black text-yellow-400 tracking-[0.5em] uppercase mb-4 block">Category</span>
                    <h1 id="inspectName" class="text-2xl md:text-3xl font-black mb-4 uppercase italic leading-tight tracking-tighter">Product Title</h1>
                    <div class="flex items-center gap-6 mb-8">
                        <span id="inspectPrice" class="text-3xl font-light text-zinc-400">₹0.00</span>
                        <span class="text-[10px] font-black text-white/20 uppercase tracking-widest border border-white/10 px-3 py-1 rounded">In Stock</span>
                    </div>

                    <!-- NEW: SIZE SELECTION CONTAINER -->
                    <div id="sizeContainer" class="hidden mb-6">
                        <h4 class="text-[9px] font-black uppercase text-zinc-500 mb-2 tracking-widest">Select Size</h4>
                        <div id="sizeOptions" class="flex flex-wrap gap-2"></div>
                    </div>
                    
                    <div class="space-y-6 mb-10">
                        <p id="inspectDesc" class="text-zinc-500 text-[11px] leading-relaxed">
                            Constructed from aerospace-grade polymers and designed with a brutalist aesthetic.
                        </p>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-[9px] font-black uppercase text-zinc-700 mb-2 tracking-widest">Material</h4>
                                <p id="inspectMaterial" class="text-xs font-bold">Cold-Pressed Carbon</p>
                            </div>
                            <div>
                                <h4 class="text-[9px] font-black uppercase text-zinc-700 mb-2 tracking-widest">Warranty</h4>
                                <p id="inspectWarranty" class="text-xs font-bold">24 Month Global</p>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-white/5">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-[9px] font-black uppercase text-zinc-500 tracking-widest">Top Reviews</h4>
                                <div class="flex items-center gap-1">
                                    <i data-lucide="star" class="w-3 h-3 fill-yellow-400 text-yellow-400"></i>
                                    <span id="inspectRatingValue" class="text-[10px] font-bold">4.8</span>
                                    <span id="inspectReviewCount" class="text-[9px] text-zinc-600 ml-1"></span>
                                </div>
                            </div>
                            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2" id="reviewsContainer"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-6 border-t border-white/5 bg-[#0A0A0A]/95 backdrop-blur-md sticky bottom-0 md:static pb-6 md:pb-0 z-20">
                    <button id="inspectAddBtn" class="flex-[3] bg-yellow-400 text-black font-black py-5 rounded-[20px] uppercase text-[11px] tracking-[0.2em] shadow-lg shadow-yellow-400/10 active:scale-95 transition-all hover:bg-yellow-300">Add To Bag</button>
                    <button id="inspectLikeBtn" class="flex-1 bg-white/5 border border-white/10 rounded-[20px] flex items-center justify-center hover:bg-white/10 transition-all">
                        <i data-lucide="heart" id="inspectLikeIcon" class="w-6 h-6 text-zinc-400"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 z-[7000] hidden flex items-center justify-center bg-black/60 backdrop-blur-md page-transition">
        <div class="bg-[#121212] border border-white/10 rounded-[32px] p-8 max-w-sm w-[90%] text-center shadow-2xl">
            <div class="w-16 h-16 bg-yellow-400/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="alert-circle" class="w-8 h-8 text-yellow-400"></i>
            </div>
            <h3 id="modalTitle" class="text-lg font-black uppercase italic mb-3">Alert</h3>
            <p id="modalMsg" class="text-zinc-500 text-xs leading-relaxed mb-8">Message</p>
            <button id="modalBtn" class="w-full bg-white text-black font-bold py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-zinc-200 transition-colors">
                OK
            </button>
        </div>
    </div>

    <!-- Confirmation Modal (For Logout) -->
    <div id="confirmModal" class="fixed inset-0 z-[7000] hidden flex items-center justify-center bg-black/60 backdrop-blur-md page-transition">
        <div class="bg-[#121212] border border-white/10 rounded-[32px] p-8 max-w-sm w-[90%] text-center shadow-2xl">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="log-out" class="w-8 h-8 text-red-500"></i>
            </div>
            <h3 id="confirmTitle" class="text-lg font-black uppercase italic mb-3">Confirm Logout</h3>
            <p id="confirmMsg" class="text-zinc-500 text-xs leading-relaxed mb-8">Are you sure you want to disconnect your session from CartiX?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 bg-white/5 text-zinc-400 font-bold py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-white/10 transition-colors">
                    Cancel
                </button>
                <button id="confirmBtnAction" class="flex-1 bg-red-500 text-white font-bold py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-red-600 transition-colors">
                    Yes, Logout
                </button>
            </div>
        </div>
    </div>

    <!-- CHANGE NAME MODAL -->
    <div id="nameChangeModal" class="fixed inset-0 z-[7000] hidden flex items-center justify-center bg-black/60 backdrop-blur-md page-transition">
        <div class="bg-[#121212] border border-white/10 rounded-[32px] p-8 max-w-sm w-[90%] text-center shadow-2xl">
            <h3 class="text-lg font-black uppercase italic mb-4">Update Profile</h3>
            <div class="space-y-4 mb-6">
                <input type="text" id="newNameInput" placeholder="Enter new name" class="w-full bg-[#1A1A1A] border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-yellow-400/50 outline-none text-white">
            </div>
            <div class="flex gap-3">
                <button onclick="closeNameChange()" class="flex-1 bg-white/5 text-zinc-400 font-bold py-4 rounded-xl text-xs uppercase tracking-widest hover:bg-white/10 transition-colors">
                    Cancel
                </button>
                <button onclick="saveNameChange()" class="flex-1 bg-yellow-400 text-black font-bold py-4 rounded-xl text-xs uppercase tracking-widest hover:scale-[1.02] transition-transform">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- 
    ========================================================================================
    ROBUST LOTTIE LOADING OVERLAY (CCE1 LOGIC + DEBUGGING) - RESTORED
    ========================================================================================
    -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <lottie-player
            id="mainLottiePlayer"
            src="https://ik.imagekit.io/lssafvcmr/CartiX/Banner/Ripple%20loading%20animation.json"
            background="transparent"
            speed="1"
            style="width: 113px; height: 113px;"
            loop
            autoplay
        ></lottie-player>
    </div>

    <!-- 
    ========================================================================================
    JAVASCRIPT LOGIC (UNIFIED & OPTIMIZED)
    ========================================================================================
    -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG (Matches your Admin Panel exactly)
        const config = { 
            apiKey: "AIzaSyALraEeY-4iEX0LVGkb6hIEtmSvSV7PYH8", 
            authDomain: "cartix-244c0.firebaseapp.com", 
            databaseURL: "https://cartix-244c0-default-rtdb.firebaseio.com", 
            projectId: "cartix-244c0", 
            storageBucket: "cartix-244c0.firebasestorage.app", 
            messagingSenderId: "221584003628", 
            appId: "1:221584003628:web:92f56f20368088e0927789", 
            measurementId: "G-QPKVMF0871" 
        };
        
        const app = initializeApp(config);
        const db = getDatabase(app);

        // --- GLOBAL VARIABLES ---
        let products = [];
        let cart = [];
        let wishlist = [];
        let addresses = [];
        let orders = [];
        let currentUser = null; // Holds the logged in user data
        let activeCat = 'All';
        let currentHero = 0;
        let currentInspectId = null;
        let currentInspectSlide = 0;
        let inspectSlidesData = [];
        let isDataLoaded = false;
        let heroImages = [];
        
        // SEARCH FILTER STATE
        let currentSearchQuery = '';
        let currentSort = null; // 'low', 'high'
        let currentRatingFilter = 0; // 0, 3, 3.5, 4, 4.5

        // NEW: SELECTED SIZE STATE
        let currentSelectedSize = null;

        // --- ROBUST LOADER LOGIC (RESTORED) ---
        window.toggleLoader = function(show) {
            const loader = document.getElementById('loadingOverlay');
            const player = document.getElementById('mainLottiePlayer');
            
            console.log(`[Loader] Triggered: ${show}`);

            if (show) {
                // 1. Make visible in layout
                loader.style.display = 'flex';
                // 2. Force slight delay to allow display to render before opacity transition
                requestAnimationFrame(() => {
                    loader.classList.remove('hidden-loader');
                    if(player) player.play();
                });
            } else {
                // 1. Start Fade Out
                loader.classList.add('hidden-loader');
                if(player) player.stop();
                
                // 2. Remove from layout after transition completes (500ms matches CSS)
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
        };

        // --- LOTTIE DEBUGGING ---
        const player = document.getElementById('mainLottiePlayer');
        if(player) {
            player.addEventListener('ready', () => console.log("[Lottie] Player Ready"));
            player.addEventListener('load', () => console.log("[Lottie] Animation Loaded"));
            player.addEventListener('error', (e) => console.error("[Lottie] Load Error:", e));
        }


        // --- IMMEDIATE FIREBASE FETCH (OPTIMIZATION) ---
        // 1. Fetch Products
        const productRef = ref(db, 'products');
        onValue(productRef, (snapshot) => {
            isDataLoaded = true;
            const data = snapshot.val();
            // SAFE DATA PARSING: Filter out null/undefined/ghost entries
            if (data) {
                // Ensure we only get valid product objects with properties
                products = Object.values(data).filter(p => p && typeof p === 'object' && p.name && p.price);
            } else {
                products = [];
            }
            
            if(document.readyState === 'complete' || document.readyState === 'interactive') {
                renderProducts();
            }
        }, (error) => {
            console.error("Firebase Read Error:", error);
        });

        // 2. Fetch Admin Banners
        const adminRef = ref(db, 'admin');
        onValue(adminRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                // Fetch banner1, banner2, banner3
                heroImages = [data.banner1, data.banner2, data.banner3].filter(Boolean);
                if(heroImages.length > 0) initHero();
            }
        });

        // 3. Fetch Orders
        const orderRef = ref(db, 'orders');
        onValue(orderRef, (snapshot) => {
            const data = snapshot.val();
            orders = data ? Object.values(data).reverse() : [];
            const historyPage = document.getElementById('orderHistoryPage');
            if (historyPage && !historyPage.classList.contains('hidden')) {
                renderOrders();
            }
        });

        // --- LOCAL STORAGE & AUTH HANDLERS ---
        class AppStorage {
            constructor() {
                this.dbName = 'CartiX_Ultimate_DB';
                this.dbVersion = 1;
                this.db = null;
            }
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('appState')) {
                            db.createObjectStore('appState', { keyPath: 'key' });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve();
                    };
                    request.onerror = (e) => reject(e);
                });
            }
            async save(key, data) {
                if(!this.db) return;
                const tx = this.db.transaction('appState', 'readwrite');
                tx.objectStore('appState').put({ key, data });
            }
            async load(key) {
                if(!this.db) return null;
                return new Promise((resolve) => {
                    const tx = this.db.transaction('appState', 'readonly');
                    const req = tx.objectStore('appState').get(key);
                    req.onsuccess = () => resolve(req.result ? req.result.data : null);
                });
            }
        }
        const appDB = new AppStorage();

        // --- AUTH LOGIC ---
        window.toggleAuth = function(mode) {
            const login = document.getElementById('loginContainer');
            const signup = document.getElementById('signupContainer');
            if (mode === 'signup') {
                login.classList.add('hidden');
                signup.classList.remove('hidden');
            } else {
                signup.classList.add('hidden');
                login.classList.remove('hidden');
            }
        };

        async function checkSession() {
            // Check localStorage for quick session ID
            const sessionMobile = localStorage.getItem('cartix_user_session');
            
            // Show loader on initial check
            toggleLoader(true);

            if (sessionMobile) {
                // Verify with DB
                const dbRef = ref(db);
                try {
                    const snapshot = await get(child(dbRef, `users/${sessionMobile}`));
                    toggleLoader(false); // Hide loader after check
                    
                    if (snapshot.exists()) {
                        currentUser = snapshot.val();
                        loginSuccess(currentUser);
                    } else {
                        // Invalid session
                        document.getElementById('authPage').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Session check failed", error);
                    toggleLoader(false);
                    document.getElementById('authPage').classList.remove('hidden');
                }
            } else {
                toggleLoader(false);
                document.getElementById('authPage').classList.remove('hidden');
            }
        }

        function loginSuccess(userData) {
            currentUser = userData;
            localStorage.setItem('cartix_user_session', userData.mobile);
            appDB.save('user_profile', userData);
            
            // Update Profile UI
            document.getElementById('profileName').innerText = userData.name;
            document.getElementById('profileMobile').innerText = `+91 ${userData.mobile}`;
            document.getElementById('addrName').value = userData.name; // Auto-fill shipping name
            document.getElementById('addrMobile').value = userData.mobile;
            
            // KEY UPDATE: Check for saved address in User Object and sync to local state
            if (userData.savedAddress) {
                // Ensure it's treated as an array for local logic
                addresses = [userData.savedAddress];
                appDB.save('addresses', addresses);
                console.log("[Sync] Address fetched from cloud.");
            }

            // Hide Auth Page
            document.getElementById('authPage').classList.add('hidden');
        }

        window.logout = function() {
            // Show Confirm Modal
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmBtnAction').onclick = () => {
                localStorage.removeItem('cartix_user_session');
                currentUser = null;
                addresses = []; // Clear current session address
                appDB.save('addresses', []);
                document.getElementById('confirmModal').classList.add('hidden');
                document.getElementById('authPage').classList.remove('hidden');
                showPage('home'); // Reset view behind overlay
            };
        };

        window.closeConfirm = function() {
            document.getElementById('confirmModal').classList.add('hidden');
        };

        // --- NAME CHANGE LOGIC ---
        window.openChangeName = function() {
            document.getElementById('nameChangeModal').classList.remove('hidden');
            document.getElementById('newNameInput').value = currentUser ? currentUser.name : '';
        };

        window.closeNameChange = function() {
            document.getElementById('nameChangeModal').classList.add('hidden');
        };

        window.saveNameChange = async function() {
            const newName = document.getElementById('newNameInput').value.trim();
            if(!newName) return;
            
            if(currentUser) {
                try {
                    const userRef = ref(db, `users/${currentUser.mobile}`);
                    await update(userRef, { name: newName });
                    
                    // Update Local State
                    currentUser.name = newName;
                    appDB.save('user_profile', currentUser);
                    document.getElementById('profileName').innerText = newName;
                    
                    // Also update address name if matching
                    document.getElementById('addrName').value = newName;

                    closeNameChange();
                    showAlert("Success", "Name updated successfully!");
                } catch(e) {
                    console.error(e);
                    showAlert("Error", "Could not update name.");
                }
            }
        };


        // --- UI INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            // 1. Load Local Data
            await appDB.init();
            cart = await appDB.load('cart') || [];
            wishlist = await appDB.load('wishlist') || [];
            addresses = await appDB.load('addresses') || [];
            // Orders are fetched live from Firebase, local storage is fallback/cache
            const localOrders = await appDB.load('orders') || [];
            if(orders.length === 0) orders = localOrders; 

            // 2. Setup UI
            lucide.createIcons();
            // initHero() calls are now handled by firebase listener
            setupSearchInteractions();
            initCustomSelect();
            initSmarty();
            setInterval(nextHero, 6000);
            updateCart();
            
            // 3. Check Authentication (Will hide initial loader when done)
            checkSession();

            // 6. Global Listeners
            document.getElementById('searchOverlay').addEventListener('click', closeSearch);
            document.getElementById('searchSuggestions').addEventListener('mousedown', (e) => e.preventDefault());
            if(document.getElementById('smartyInput')) {
                document.getElementById('smartyInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSmartyInput();
                });
            }

            // --- PINCH ZOOM LOGIC ---
            const zoomOverlay = document.getElementById('zoomOverlay');
            const zoomImage = document.getElementById('zoomImage');
            
            let currentScale = 1;
            let initialDistance = 0;
            let isDragging = false;
            let startX, startY, currentX = 0, currentY = 0;

            function getDistance(touches) {
                return Math.hypot(
                    touches[0].clientX - touches[1].clientX,
                    touches[0].clientY - touches[1].clientY
                );
            }

            zoomImage.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    // Pinch started
                    initialDistance = getDistance(e.touches);
                    isDragging = false;
                } else if (e.touches.length === 1 && currentScale > 1) {
                    // Pan started (only if zoomed in)
                    isDragging = true;
                    startX = e.touches[0].clientX - currentX;
                    startY = e.touches[0].clientY - currentY;
                }
            });

            zoomImage.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent default scroll

                if (e.touches.length === 2) {
                    // Pinching
                    const newDistance = getDistance(e.touches);
                    const scaleChange = newDistance / initialDistance;
                    
                    // Update scale but limit it
                    let newScale = currentScale * scaleChange;
                    newScale = Math.min(Math.max(1, newScale), 5); // Limit 1x to 5x

                    // Apply transform
                    zoomImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${newScale})`;
                    
                    // Update variables for smoother tracking (simplified for continuous gesture)
                    // Note: A truly perfect pinch zoom keeps updating currentScale reference.
                    // But we keep it simple here relative to start of pinch.
                } else if (e.touches.length === 1 && isDragging && currentScale > 1) {
                    // Panning
                    currentX = e.touches[0].clientX - startX;
                    currentY = e.touches[0].clientY - startY;
                    zoomImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
                }
            });
            
            // Revised pinch logic variables for robustness
            let pinchStartScale = 1;
            
            zoomImage.addEventListener('touchstart', (e) => {
                if(e.touches.length === 2) {
                    initialDistance = getDistance(e.touches);
                    pinchStartScale = currentScale;
                }
            });
            
            zoomImage.addEventListener('touchmove', (e) => {
                if(e.touches.length === 2) {
                    const dist = getDistance(e.touches);
                    currentScale = pinchStartScale * (dist / initialDistance);
                    // Clamp
                    currentScale = Math.min(Math.max(1, currentScale), 5);
                    zoomImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
                }
            });

            zoomImage.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    if (currentScale < 1.1) {
                        // Snap back if zoomed out too much
                        currentScale = 1;
                        currentX = 0;
                        currentY = 0;
                        zoomImage.style.transform = `translate(0px, 0px) scale(1)`;
                    }
                }
            });
        });
        
        // --- AUTH EVENT LISTENERS ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mobile = document.getElementById('loginMobile').value;
            const pass = document.getElementById('loginPass').value;
            
            if (mobile.length !== 10) {
                showAlert("Invalid Mobile", "Please enter a valid 10-digit mobile number.");
                return;
            }

            // SHOW LOADING ANIMATION
            toggleLoader(true);

            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, `users/${mobile}`));
                
                // Hide loader before decision to ensure UI is ready for alert
                toggleLoader(false);

                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === pass) {
                        // Success
                        loginSuccess(userData);
                    } else {
                        showAlert("Access Denied", "Incorrect Password.");
                    }
                } else {
                    showAlert("User Not Found", "No account exists with this mobile number.");
                }
            } catch (error) {
                toggleLoader(false);
                showAlert("Error", "Connection failed. Please try again.");
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const mobile = document.getElementById('regMobile').value;
            const pass = document.getElementById('regPass').value;
            const confirm = document.getElementById('regConfirmPass').value;
            
            if (mobile.length !== 10) {
                showAlert("Invalid Mobile", "Please enter a valid 10-digit mobile number.");
                return;
            }
            if (pass.length < 8) {
                showAlert("Weak Password", "Password must be at least 8 characters long.");
                return;
            }
            if (pass !== confirm) {
                showAlert("Mismatch", "Passwords do not match.");
                return;
            }

            // SHOW LOADING ANIMATION
            toggleLoader(true);

            const dbRef = ref(db);
            try {
                // Check if user exists
                const snapshot = await get(child(dbRef, `users/${mobile}`));
                if (snapshot.exists()) {
                    toggleLoader(false);
                    showAlert("Exists", "User already registered. Please Login.");
                    return;
                }

                // Create User
                const newUser = {
                    name: name,
                    mobile: mobile,
                    password: pass, // Storing as requested
                    joined: new Date().toISOString()
                };

                await set(ref(db, 'users/' + mobile), newUser);
                
                toggleLoader(false);
                loginSuccess(newUser);
                showAlert("Welcome", "Account created successfully!");
                
            } catch (error) {
                console.error(error);
                toggleLoader(false);
                showAlert("Error", "Could not create account.");
            }
        });


        // --- GLOBAL FUNCTIONS (Attached to Window for HTML Access) ---
        
        window.showPage = function(page) {
            if (page !== 'home' && page !== 'search') closeSearch();
            
            const pages = ['home', 'likes', 'cart', 'profile', 'shipping', 'orderHistory', 'orderDetail', 'smarty', 'security', 'search'];
            pages.forEach(id => {
                const el = document.getElementById(id + 'Page');
                if(el) el.classList.add('hidden');
            });
            
            const targetPage = document.getElementById(page + 'Page');
            if(targetPage) targetPage.classList.remove('hidden');
            
            const navDock = document.getElementById('navDock');
            const searchContainer = document.getElementById('searchContainer');
            
            // SMART NAV HIDING LOGIC
            if (page === 'search') {
                navDock.style.display = 'none'; // Hide Dock completely
                searchContainer.style.opacity = '1';
                searchContainer.style.pointerEvents = 'auto';
            } else {
                navDock.style.display = 'flex'; // Restore Dock
                
                if (page === 'home') {
                    searchContainer.style.opacity = '1';
                    searchContainer.style.pointerEvents = 'auto';
                } else {
                    searchContainer.style.opacity = '0.3';
                    searchContainer.style.pointerEvents = 'none';
                }

                if (page === 'smarty') {
                    navDock.style.transform = 'translate(-50%, 200%)';
                } else {
                    navDock.style.transform = 'translate(-50%, 0)';
                }
            }

            document.querySelectorAll('.dock-item').forEach(el => {
                el.classList.toggle('active', el.dataset.page === page);
            });

            if(page === 'cart') updateCart();
            if(page === 'likes') renderWishlist();
            if(page === 'orderHistory') renderOrders();
            
            // AUTO-FILL LOGIC: If showing shipping page, pre-fill form
            if(page === 'shipping') {
                if(addresses && addresses.length > 0) {
                    const saved = addresses[0];
                    document.getElementById('addrName').value = saved.name || '';
                    document.getElementById('addrMobile').value = saved.mobile || '';
                    document.getElementById('addrAltMobile').value = saved.altMobile || '';
                    document.getElementById('addrHouse').value = saved.house || '';
                    document.getElementById('addrArea').value = saved.area || '';
                    document.getElementById('addrPincode').value = saved.pincode || '';
                    document.getElementById('addrCity').value = saved.city || '';
                    document.getElementById('addrDistrict').value = saved.district || '';
                    document.getElementById('selectedState').innerText = saved.state || 'Select State';
                } else if (currentUser) {
                    // Fallback to minimal user info
                    document.getElementById('addrName').value = currentUser.name;
                    document.getElementById('addrMobile').value = currentUser.mobile;
                }
            }
            
            if(page !== 'smarty') window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function initHero() {
            const el = document.getElementById('heroSlider');
            const dots = document.getElementById('heroDots');
            // If no images fetched yet, don't break
            if (!heroImages || heroImages.length === 0) return;
            
            el.innerHTML = heroImages.map(img => `<img src="${img}" class="min-w-full h-full object-cover transition-opacity duration-500" onload="document.getElementById('heroContainer').classList.remove('premium-skeleton')">`).join('');
            dots.innerHTML = heroImages.map((_, i) => `<div class="slider-dot ${i===0?'active':''}"></div>`).join('');
        }

        function nextHero() {
            if(heroImages.length === 0) return;
            currentHero = (currentHero + 1) % heroImages.length;
            const slider = document.getElementById('heroSlider');
            if(slider) slider.style.transform = `translateX(-${currentHero * 100}%)`;
            document.querySelectorAll('#heroDots .slider-dot').forEach((d, i) => d.classList.toggle('active', i === currentHero));
        }

        // --- SEARCH LOGIC ---
        function setupSearchInteractions() {
            const input = document.getElementById('searchInput');
            const body = document.getElementById('mainBody');

            // Focus event: Show suggestions (Empty = Random, Typed = Matched)
            input.addEventListener('focus', () => {
                body.classList.add('is-searching');
                updateSuggestions(input.value);
            });

            // Typing event
            input.addEventListener('input', (e) => updateSuggestions(e.target.value));

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearchQuery = input.value.trim();
                    if(currentSearchQuery) {
                        enterSearchMode(currentSearchQuery);
                    }
                }
            });
        }

        window.closeSearch = function() {
            const input = document.getElementById('searchInput');
            const body = document.getElementById('mainBody');

            body.classList.remove('is-searching');
            input.value = '';
            input.blur();
            // Don't clear search page immediately if user is browsing results
        };

        window.enterSearchMode = function(query) {
            closeSearch();
            
            // Show Loader momentarily
            toggleLoader(true);
            setTimeout(() => {
                toggleLoader(false);
                showPage('search');
                document.getElementById('searchQueryDisplay').innerText = query;
                currentSearchQuery = query;
                // Reset filters
                currentSort = null;
                currentRatingFilter = 0;
                updateFilterChips();
                renderSearchResults();
            }, 800); // 0.8s fake delay for effect
        };

        window.applyFilter = function(type, value) {
            if(type === 'price') {
                if(currentSort === value) currentSort = null; // toggle off
                else currentSort = value;
            } else if(type === 'rating') {
                if(currentRatingFilter === value) currentRatingFilter = 0; // toggle off
                else currentRatingFilter = value;
            }
            updateFilterChips();
            renderSearchResults();
        };

        function updateFilterChips() {
            // Price Chips
            document.getElementById('filter-price-low').classList.toggle('active', currentSort === 'low');
            document.getElementById('filter-price-high').classList.toggle('active', currentSort === 'high');
            
            // Rating Chips
            document.getElementById('filter-rating-45').classList.toggle('active', currentRatingFilter === 4.5);
            document.getElementById('filter-rating-4').classList.toggle('active', currentRatingFilter === 4);
            document.getElementById('filter-rating-3').classList.toggle('active', currentRatingFilter === 3);
        }

        function updateSuggestions(val) {
            const list = document.getElementById('suggestionList');
            
            if (!val) {
                // EMPTY INPUT: SHOW RANDOM SUGGESTIONS
                if (products.length > 0) {
                    // Shuffle array and take 3
                    const shuffled = [...products].sort(() => 0.5 - Math.random());
                    const randoms = shuffled.slice(0, 3);
                    list.innerHTML = randoms.map(p => `
                        <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg cursor-pointer transition-colors" onclick="openInspect(${p.id}); closeSearch()">
                            <img src="${p.image}" class="w-10 h-10 rounded-lg object-cover bg-white/5">
                            <div>
                                <p class="text-[11px] font-bold text-white">${p.name}</p>
                                <p class="text-[9px] text-zinc-500 uppercase tracking-wider">Suggested</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '';
                }
                return;
            }

            // TYPED INPUT: MATCHING LOGIC (Tags + Name + Category)
            const terms = val.toLowerCase().split(' ').filter(t => t.length > 0);
            
            const matches = products.filter(p => {
                const searchable = `${p.name} ${p.category} ${p.tags || ''}`.toLowerCase();
                return terms.every(term => searchable.includes(term));
            }).slice(0, 3);
            
            if(matches.length > 0) {
                list.innerHTML = matches.map(p => `
                    <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg cursor-pointer transition-colors" onclick="openInspect(${p.id}); closeSearch()">
                        <img src="${p.image}" class="w-10 h-10 rounded-lg object-cover bg-white/5">
                        <div>
                            <p class="text-[11px] font-bold text-white">${p.name}</p>
                            <p class="text-[9px] text-zinc-500 uppercase tracking-wider">${p.category}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = `<div class="p-3 text-[10px] text-zinc-600 text-center italic">No items found matching "${val}"</div>`;
            }
        }

        function renderSearchResults() {
            const list = document.getElementById('searchResultList');
            const queryWords = currentSearchQuery.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            
            // Filter logic: 10x Better Deep Search with Tags
            let results = products.filter(p => {
                if(!p) return false;
                
                const name = (p.name || '').toLowerCase();
                const tags = (p.tags || '').toLowerCase();
                const cat = (p.category || '').toLowerCase();
                const desc = (p.description || '').toLowerCase();
                
                const fullSearchString = `${name} ${tags} ${cat} ${desc}`;
                const matchesSearch = queryWords.every(word => fullSearchString.includes(word));
                
                // Add Rating Filter
                const rating = parseFloat(p.rating || 4.5); 
                const matchesRating = rating >= currentRatingFilter;

                return matchesSearch && matchesRating;
            });

            // Sorting logic
            if(currentSort === 'low') {
                results.sort((a, b) => a.price - b.price);
            } else if(currentSort === 'high') {
                results.sort((a, b) => b.price - a.price);
            }

            if(results.length === 0) {
                list.innerHTML = `<div class="col-span-full py-32 text-center text-zinc-600 text-xs tracking-widest uppercase">No items found</div>`;
                return;
            }

            list.innerHTML = results.map(p => {
                const ratingVal = p.rating || 4.8;
                return `
                <div class="search-card bg-[#121212] border border-white/5 p-4 rounded-3xl flex gap-4 overflow-hidden relative group h-[160px]">
                    <div class="w-1/3 h-full rounded-2xl bg-[#0A0A0A] overflow-hidden relative shrink-0 premium-skeleton">
                        <img src="${p.image}" class="w-full h-full object-cover cursor-pointer" onclick="openInspect(${p.id}); closeSearch()" onload="this.parentElement.classList.remove('premium-skeleton')">
                    </div>
                    <div class="w-2/3 flex flex-col justify-between py-1">
                        <div>
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-sm text-white uppercase leading-tight line-clamp-2 pr-6">${p.name}</h3>
                                <button onclick="toggleWishlist(${p.id})" class="absolute top-4 right-4 text-zinc-500 hover:text-red-500 transition-colors">
                                    <i data-lucide="heart" class="w-5 h-5 ${wishlist.includes(p.id) ? 'fill-red-500 text-red-500' : ''}"></i>
                                </button>
                            </div>
                            <p class="text-[9px] text-zinc-500 line-clamp-2 leading-relaxed mb-2">${p.description || 'Premium quality gear designed for performance.'}</p>
                            <div class="flex items-center gap-1.5 mb-2">
                                <span class="bg-yellow-400/20 text-yellow-400 text-[9px] font-bold px-2 py-0.5 rounded flex items-center gap-1">
                                    ${ratingVal} <i data-lucide="star" class="w-2 h-2 fill-yellow-400"></i>
                                </span>
                                <span class="text-[9px] text-zinc-600">(${Math.floor(Math.random() * 100) + 10})</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-black text-white">₹${(p.price || 0).toLocaleString()}</span>
                            <button onclick="addToCart(${p.id})" class="bg-white text-black text-[9px] font-bold uppercase px-4 py-2.5 rounded-full hover:bg-yellow-400 transition-colors">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        // --- RENDER PRODUCTS (SMOOTH CATEGORY SWITCH) ---
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            
            if(!isDataLoaded && products.length === 0) return;

            const filtered = products.filter(p => 
                activeCat === 'All' || (p.category && p.category.toLowerCase() === activeCat.toLowerCase())
            );

            if(filtered.length === 0) {
                grid.innerHTML = `
                <div class="col-span-full py-32 text-center">
                    <p class="text-[10px] font-black uppercase text-zinc-700 tracking-[0.5em]">No Assets Found</p>
                </div>`;
                return;
            }

            grid.innerHTML = filtered.map(p => `
                <div class="group cursor-pointer fade-in-up">
                    <div class="aspect-[4/5] rounded-[32px] bg-[#141414] border border-white/5 overflow-hidden mb-5 relative premium-skeleton">
                        <img src="${p.image}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onload="this.parentElement.classList.remove('premium-skeleton')">
                        <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="absolute top-4 right-4 translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                            <button onclick="event.stopPropagation(); toggleWishlist(${p.id})" class="p-3 bg-black/60 backdrop-blur-xl rounded-full border border-white/10 hover:bg-yellow-400 hover:text-black transition-colors">
                                <i data-lucide="heart" class="w-4 h-4 ${wishlist.includes(p.id) ? 'fill-red-500 text-red-500' : ''}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="px-2" onclick="openInspect(${p.id})">
                        <p class="text-[9px] text-zinc-600 font-black uppercase tracking-[0.2em] mb-1.5">${p.category}</p>
                        <h3 class="font-bold text-sm text-white uppercase tracking-tight group-hover:text-yellow-400 transition-colors leading-tight truncate">${p.name}</h3>
                        <p class="font-black text-sm text-white/50 mt-1.5">₹${(p.price || 0).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.filterCategory = function(cat) {
            activeCat = cat;
            // Update Buttons State
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const btnText = btn.innerText.trim();
                const isSelected = btnText.toLowerCase() === cat.toLowerCase(); 
                if(isSelected) {
                    btn.className = "cat-btn active px-8 py-3.5 rounded-2xl border border-white/5 text-[10px] font-black uppercase bg-yellow-400 text-black transition-all";
                } else {
                    btn.className = "cat-btn px-8 py-3.5 rounded-2xl border border-white/10 text-[10px] font-black uppercase text-zinc-500 hover:text-white transition-all";
                }
            });
            // Instant render (Animation handled by CSS keyframes)
            renderProducts(); 
        };

        // --- CART & ACTIONS ---
        function updateCart() {
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
            document.getElementById('totalVal').innerText = `₹${total.toLocaleString()}`;
            document.getElementById('subTotalVal').innerText = `₹${total.toLocaleString()}`;
            appDB.save('cart', cart);

            const list = document.getElementById('cartItemsList');
            list.innerHTML = cart.length === 0 ? `
                <div class="py-32 text-center border border-dashed border-white/10 rounded-[32px] bg-white/5">
                    <i data-lucide="shopping-bag" class="w-10 h-10 text-zinc-700 mx-auto mb-4"></i>
                    <p class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Bag Empty</p>
                </div>
            ` : cart.map(i => `
                <div class="flex gap-6 items-center bg-[#121212] p-4 rounded-[28px] border border-white/5 hover:border-white/10 transition-all">
                    <div class="w-20 h-24 rounded-2xl overflow-hidden shrink-0 bg-black">
                        <img src="${i.image}" class="w-full h-full object-cover opacity-90">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="text-xs font-black uppercase tracking-tight mb-1 text-white">${i.name}</h4>
                                ${i.size ? `<span class="text-[9px] font-bold text-zinc-500 bg-white/5 px-2 py-0.5 rounded border border-white/5">Size: ${i.size}</span>` : ''}
                                <p class="text-yellow-400 text-[11px] font-black mt-1">₹${(i.price || 0).toLocaleString()}</p>
                            </div>
                            <button onclick="removeItem(${i.id})" class="p-2 hover:bg-red-500/10 rounded-full text-zinc-600 hover:text-red-500 transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-4 bg-white/5 w-fit px-4 py-2 rounded-xl border border-white/5">
                            <button onclick="changeQty(${i.id}, -1)" class="text-zinc-400 hover:text-white transition-colors text-lg leading-none">-</button>
                            <span class="font-black text-xs min-w-[16px] text-center">${i.qty}</span>
                            <button onclick="changeQty(${i.id}, 1)" class="text-zinc-400 hover:text-white transition-colors text-lg leading-none">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.toggleWishlist = function(id) {
            if(wishlist.includes(id)) {
                wishlist = wishlist.filter(x => x !== id);
            } else {
                wishlist.push(id);
            }
            appDB.save('wishlist', wishlist);
            if(currentInspectId === id) updateInspectLikeIcon();
            
            // Re-render wherever we are to show updated heart
            renderProducts();
            if(!document.getElementById('searchPage').classList.contains('hidden')) renderSearchResults();
            if(!document.getElementById('likesPage').classList.contains('hidden')) renderWishlist();
        };

        function renderWishlist() {
            const items = products.filter(p => wishlist.includes(p.id));
            const grid = document.getElementById('wishlistGrid');
            grid.innerHTML = items.length === 0 ? `
                <div class="col-span-full py-40 text-center border-2 border-dashed border-white/5 rounded-[40px]">
                    <p class="text-[10px] font-black text-zinc-700 uppercase tracking-[0.4em]">Nothing Bookmarked</p>
                </div>
            ` : items.map(p => `
                <div class="group" onclick="openInspect(${p.id})">
                    <div class="aspect-[4/5] rounded-[32px] bg-[#141414] border border-white/5 overflow-hidden mb-4 relative premium-skeleton">
                        <img src="${p.image}" class="w-full h-full object-cover" onload="this.parentElement.classList.remove('premium-skeleton')">
                    </div>
                    <h3 class="font-bold text-xs uppercase text-zinc-300 truncate">${p.name}</h3>
                    <p class="text-yellow-400 font-bold text-xs mt-1">₹${(p.price || 0).toLocaleString()}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.addToCart = function(id) {
            const p = products.find(i => i.id == id);
            if (!p) return;

            // NEW: SIZE VALIDATION
            let sizes = [];
            if(p.size) {
                // If it's a string like "S, M, L", split it. If array, use it.
                sizes = Array.isArray(p.size) ? p.size : p.size.split(',').map(s => s.trim());
            }

            if (sizes.length > 0 && !currentSelectedSize) {
                showAlert("Select Option", "Please select a size before adding to cart.");
                return;
            }

            // Logic to handle same item different size?
            // Simplified: If ID matches AND size matches, increment qty.
            const existingItem = cart.find(i => i.id == id && i.size == currentSelectedSize);
            
            if(existingItem) {
                existingItem.qty++;
            } else {
                cart.push({...p, qty: 1, size: currentSelectedSize});
            }

            updateCart();
            closeInspect();
            showPage('cart');
        };

        window.changeQty = function(id, d) {
            const item = cart.find(x => x.id == id);
            item.qty += d;
            if(item.qty <= 0) removeItem(id);
            updateCart();
        };

        window.removeItem = function(id) {
            cart = cart.filter(i => i.id != id);
            updateCart();
        };

        // --- RAZORPAY PAYMENT & CHECKOUT LOGIC ---
        window.checkout = function() {
            if(cart.length === 0) return;
            
            // 1. CHECK IF ARRAY EXISTS
            if(!addresses || addresses.length === 0) {
                showAlert("Missing Address", "Please add a shipping address.");
                document.getElementById('modalBtn').onclick = () => {
                    document.getElementById('alertModal').classList.add('hidden');
                    showPage('shipping');
                };
                return;
            }

            // 2. STRICT DEEP VALIDATION (Fixed Logic)
            const addr = addresses[0];
            // Added check for 'area' and removed strict check for 'state' if it defaults to Select State but is saved as string
            if(!addr.name || !addr.mobile || !addr.house || !addr.area || !addr.pincode || !addr.city || !addr.state || addr.state === "Select State") {
                 showAlert("Incomplete Address", "Your shipping address is incomplete. Please update all required fields.");
                 document.getElementById('modalBtn').onclick = () => {
                    document.getElementById('alertModal').classList.add('hidden');
                    showPage('shipping');
                };
                 return;
            }

            // 3. START RAZORPAY FLOW
            const totalAmount = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            const RAZORPAY_KEY_ID = "rzp_live_S1KHvYmm18OxcO"; // Client Side Key Only

            const options = {
                "key": RAZORPAY_KEY_ID, 
                "amount": totalAmount * 100, // Amount in paise
                "currency": "INR",
                "name": "CartiX Premium",
                "description": "Order Payment",
                "image": "https://cdn.lucide.dev/icon/shopping-bag", // Simple icon for modal
                "handler": function (response){
                    // Payment Success! Now place order in Firebase
                    placeFirebaseOrder(response, totalAmount, addr);
                },
                "prefill": {
                    "name": currentUser ? currentUser.name : "Guest",
                    "contact": currentUser ? currentUser.mobile : ""
                },
                "theme": {
                    "color": "#FFC700" // Matches CartiX Accent
                }
            };

            const rzp1 = new Razorpay(options);
            
            rzp1.on('payment.failed', function (response){
                showAlert("Payment Failed", response.error.description || "Transaction failed.");
            });

            rzp1.open();
        };

        // INTERNAL FUNCTION: Place Order AFTER Payment
        async function placeFirebaseOrder(paymentDetails, amount, addr) {
            // SHOW LOADING ANIMATION
            toggleLoader(true);

            const newOrder = {
                id: Math.random().toString(36).substr(2, 9).toUpperCase(),
                date: new Date().toISOString(),
                status: "Placed (Paid)",
                paymentId: paymentDetails.razorpay_payment_id,
                items: [...cart],
                total: amount,
                address: addr,
                userMobile: currentUser ? currentUser.mobile : 'guest',
                userFullName: currentUser ? currentUser.name : 'Guest'
            };

            try {
                // FIXED: Use set() instead of push() to avoid duplicates and ensure custom ID as key
                await set(ref(db, 'orders/' + newOrder.id), newOrder);
                
                toggleLoader(false);
                showAlert("Order Confirmed", `Payment Successful! Order #${newOrder.id} has been placed.`);
                cart = [];
                updateCart();
                showPage('home');
            } catch (error) {
                console.error("Firebase Error", error);
                toggleLoader(false);
                showAlert("Error", "Payment successful, but order syncing failed. Contact support with ID: " + paymentDetails.razorpay_payment_id);
            }
        }

        function showAlert(title, msg) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            document.getElementById('alertModal').classList.remove('hidden');
            document.getElementById('modalBtn').onclick = () => {
                document.getElementById('alertModal').classList.add('hidden');
            };
        }

        window.showPaymentModal = function() {
            showAlert("Prepaid Only", "We currently accept prepaid orders only. COD is disabled for security verification.");
        };

        window.filterOrders = function(type) {
            const activeBtn = "flex-1 py-3 rounded-xl bg-yellow-400 text-black text-xs font-black uppercase shadow-lg shadow-yellow-400/20";
            const inactiveBtn = "flex-1 py-3 rounded-xl bg-white/5 text-zinc-500 text-xs font-black uppercase hover:bg-white/10";
            
            document.getElementById('tabActive').className = type === 'active' ? activeBtn : inactiveBtn;
            document.getElementById('tabCompleted').className = type === 'completed' ? activeBtn : inactiveBtn;
            renderOrders(type);
        };

        window.renderOrders = function(filter = 'active') {
            const list = document.getElementById('ordersList');
            const term = document.getElementById('orderSearch').value.toLowerCase();
            const activeStatuses = ['Order Placed', 'Placed (Paid)', 'Placed', 'Confirmed', 'Packed', 'Shipped', 'In Transit', 'Out for Delivery'];
            
            // Filter by user also
            const userOrders = orders.filter(o => currentUser && o.userMobile === currentUser.mobile);

            const filtered = userOrders.filter(o => 
                o.id.toLowerCase().includes(term) && 
                (filter === 'active' ? activeStatuses.includes(o.status) : o.status === 'Delivered')
            ).reverse();

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-zinc-600 text-[10px] uppercase font-black tracking-widest border border-dashed border-white/5 rounded-2xl">No orders found</div>`;
                return;
            }

            list.innerHTML = filtered.map(o => {
                const isDelivered = o.status === 'Delivered';
                // GREEN STATUS CARD FOR DELIVERED ITEMS
                const statusColor = isDelivered 
                    ? 'bg-green-500/10 text-green-500 border-green-500/20' 
                    : 'bg-yellow-400/10 text-yellow-400 border-yellow-400/20';

                return `
                <div onclick="showOrderDetail('${o.id}')" class="bg-[#121212] border border-white/5 p-5 rounded-[24px] cursor-pointer hover:border-yellow-400/30 transition-all group">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[10px] text-zinc-500 uppercase font-black tracking-widest mb-1 group-hover:text-white transition-colors">Order #${o.id}</p>
                            <p class="text-sm font-bold">${o.items ? o.items.length : 0} Items • ₹${o.total.toLocaleString()}</p>
                        </div>
                        <span class="px-3 py-1 text-[9px] font-black uppercase rounded-lg border ${statusColor}">${o.status}</span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        ${o.items ? o.items.map(i => `<div class="relative"><img src="${i.image}" class="w-12 h-12 rounded-lg object-cover bg-white/5">${i.size ? `<span class="absolute bottom-0 right-0 bg-black text-white text-[8px] font-bold px-1">${i.size}</span>` : ''}</div>`).join('') : ''}
                    </div>
                </div>
            `}).join('');
        };

        window.showOrderDetail = function(id) {
            const order = orders.find(o => o.id == id);
            if(!order) return;
            
            const stages = ["Order Placed", "Confirmed", "Packed", "Shipped", "In Transit", "Out for Delivery", "Delivered"];
            
            // Map "Placed (Paid)" to "Order Placed" for tracking visuals
            let visualStatus = order.status;
            if(visualStatus === "Placed (Paid)") visualStatus = "Order Placed";

            const currentStageIndex = stages.indexOf(visualStatus);
            
            const trackingHTML = stages.map((stage, i) => {
                const isCompleted = i <= currentStageIndex;
                const isCurrent = i === currentStageIndex;
                const isDeliveredStage = stage === "Delivered";
                
                // Styles
                let dotStyle = '';
                let lineStyle = '';
                let textStyle = '';
                let statusMsg = '';

                // Line Logic (connects to next)
                if (i !== stages.length - 1) {
                    lineStyle = isCompleted ? 'bg-yellow-400' : 'bg-zinc-800';
                }

                // Dot & Text Logic
                if (isCompleted) {
                    if (isDeliveredStage) {
                        // Green Theme for Delivered
                        dotStyle = 'bg-green-500 border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]';
                        textStyle = 'text-green-500';
                    } else {
                        // Yellow Theme for others
                        dotStyle = 'bg-yellow-400 border-yellow-400 shadow-[0_0_10px_rgba(255,199,0,0.5)]';
                        textStyle = 'text-white';
                    }
                } else {
                    // Incomplete
                    dotStyle = 'bg-[#0A0A0A] border-zinc-800';
                    textStyle = 'text-zinc-600';
                }

                // Animation & Message
                if (isCurrent) {
                    if (isDeliveredStage) {
                        // Success Message, No Processing
                        statusMsg = '<p class="text-[9px] text-green-500 font-bold mt-1 tracking-wide">Successfully Delivered</p>';
                    } else {
                        dotStyle += ' animate-pulse'; // Pulse yellow
                        statusMsg = '<p class="text-[9px] text-yellow-400 font-bold mt-1 tracking-wide">Processing...</p>';
                    }
                }

                return `
                    <div class="flex gap-4 tracking-step">
                        <div class="flex flex-col items-center">
                            <div class="dot w-3.5 h-3.5 rounded-full border-2 z-10 transition-all ${dotStyle}"></div>
                            ${i !== stages.length - 1 ? `<div class="line w-[1px] h-10 -my-1 ${lineStyle}"></div>` : ''}
                        </div>
                        <div class="pb-6 ${textStyle}">
                            <h4 class="text-[11px] font-bold uppercase transition-colors">${stage}</h4>
                            ${statusMsg}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('orderDetailContent').innerHTML = `
                <div class="bg-[#121212] border border-white/5 p-6 rounded-[32px] mb-6">
                    <div class="flex justify-between mb-6 border-b border-white/5 pb-4">
                        <span class="text-xs text-zinc-500 font-bold">Order ID</span>
                        <span class="text-xs text-white font-black">#${order.id}</span>
                    </div>
                     <div class="space-y-4 mb-6">
                        ${order.items.map(i => `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <img src="${i.image}" class="w-10 h-10 rounded-lg object-cover">
                                    <div>
                                        <p class="text-xs font-bold text-white">${i.name}</p>
                                        ${i.size ? `<p class="text-[9px] text-zinc-500">Size: ${i.size}</p>` : ''}
                                        <p class="text-[9px] text-zinc-500">Qty: ${i.qty}</p>
                                    </div>
                                </div>
                                <p class="text-xs font-bold">₹${(i.price * i.qty).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between pt-4 border-t border-white/5">
                        <span class="text-sm font-bold">Total Amount</span>
                        <span class="text-sm font-black text-yellow-400">₹${order.total.toLocaleString()}</span>
                    </div>
                    ${order.paymentId ? `<div class="mt-4 pt-4 border-t border-white/5 text-[9px] text-zinc-600 font-mono">Payment ID: ${order.paymentId}</div>` : ''}
                </div>
                <div class="bg-[#121212] border border-white/5 p-8 rounded-[32px]">
                    <h3 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-6">Tracking Timeline</h3>
                    <div class="pl-2">${trackingHTML}</div>
                </div>
            `;
            showPage('orderDetail');
        };

        // --- SMARTY ---
        const smartyKnowledge = {
            "root": [
                { id: "orders", text: "Order Issues" },
                { id: "payment", text: "Payment & Refunds" },
                { id: "product", text: "Product Info" },
                { id: "account", text: "Account Settings" },
                { id: "shipping", text: "Shipping Info" },
                { id: "partners", text: "Partnerships" }
            ],
            "orders": [
                { id: "track", text: "Where is my order?" },
                { id: "cancel", text: "How to cancel?" },
                { id: "missing", text: "Item missing" },
                { id: "return", text: "Return Policy" }
            ],
            "payment": [
                { id: "refund_status", text: "Refund Status" },
                { id: "failed", text: "Payment Failed" },
                { id: "methods", text: "Accepted Cards" }
            ],
            "answers": {
                "track": "You can track your order directly in the 'Order History' tab. Tap the order card to see the live timeline.",
                "cancel": "Orders can be cancelled within 30 minutes of placement via the Order Detail page.",
                "missing": "We're sorry to hear that. Please email support@cartix.com with your unboxing video.",
                "return": "We accept returns within 7 days of delivery for defective items.",
                "refund_status": "Refunds are initiated instantly but may take 5-7 business days to reflect in your bank.",
                "failed": "If your money was deducted, it will be auto-refunded within 48 hours. No action needed.",
                "methods": "We currently accept all major Indian Credit/Debit cards and UPI.",
                "shipping": "Shipping is free on all orders above ₹999. Standard delivery takes 3-5 business days.",
                "partners": "For B2B inquiries, please mail us at partnerships@cartix.com"
            }
        };

        function initSmarty() {
            renderSmartyOptions('root');
        }

        function renderSmartyOptions(level) {
            const container = document.getElementById('chatControls');
            const data = smartyKnowledge[level];

            if(data) {
                container.innerHTML = data.map(opt => `
                    <button onclick="handleSmartyClick('${opt.id}', '${opt.text}')" class="whitespace-nowrap px-4 py-2 bg-[#1A1A1A] hover:bg-yellow-400 hover:text-black border border-white/10 rounded-full text-[10px] font-bold uppercase transition-all flex-shrink-0">
                        ${opt.text}
                    </button>
                `).join('');
                if(level !== 'root') {
                    container.innerHTML += `<button onclick="renderSmartyOptions('root')" class="whitespace-nowrap px-4 py-2 bg-red-500/10 text-red-400 border border-red-500/10 rounded-full text-[10px] font-bold uppercase flex-shrink-0 hover:bg-red-500/20">Back</button>`;
                }
            }
        }

        window.handleSmartyClick = function(id, text) {
            addSmartyMessage(text, 'user');
            setTimeout(() => {
                if(smartyKnowledge[id]) {
                    renderSmartyOptions(id);
                    addSmartyMessage("What specific issue are you facing?", 'bot');
                } else if(smartyKnowledge.answers[id]) {
                    addSmartyMessage(smartyKnowledge.answers[id], 'bot');
                    renderSmartyOptions('root');
                } else {
                    addSmartyMessage("I'm still learning! Please contact human support.", 'bot');
                    renderSmartyOptions('root');
                }
            }, 600);
        };

        window.handleSmartyInput = function() {
            const input = document.getElementById('smartyInput');
            const val = input.value.trim();
            if(!val) return;
            
            addSmartyMessage(val, 'user');
            input.value = '';
            
            setTimeout(() => {
                addSmartyMessage("I am a demo AI. Please use the options below for common queries.", 'bot');
            }, 800);
        };

        function addSmartyMessage(text, sender) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `smarty-message ${sender}`;
            div.innerText = text;
            container.appendChild(div);
            setTimeout(() => {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }, 50);
        }

        window.renderSmartyOptions = renderSmartyOptions; 

        // --- INSPECT OVERLAY ---
        window.openInspect = function(id) {
            currentInspectId = id;
            currentInspectSlide = 0;
            currentSelectedSize = null; // Reset size selection

            const p = products.find(i => i.id == id);
            
            if(!p) return;

            document.getElementById('inspectName').innerText = p.name;
            document.getElementById('inspectCat').innerText = p.category;
            document.getElementById('inspectPrice').innerText = `₹${(p.price || 0).toLocaleString()}`;
            document.getElementById('inspectDesc').innerText = p.description || "Constructed from aerospace-grade polymers.";
            
            // DYNAMIC DATA FOR MATERIAL & WARRANTY (From Firebase)
            document.getElementById('inspectMaterial').innerText = p.material || "Standard Grade";
            document.getElementById('inspectWarranty').innerText = p.warranty || "Standard 1 Year";

            // --- SIZE LOGIC ---
            const sizeContainer = document.getElementById('sizeContainer');
            const sizeOptions = document.getElementById('sizeOptions');
            let sizes = [];

            if (p.size) {
                // Determine if array or string
                sizes = Array.isArray(p.size) ? p.size : p.size.split(',').map(s => s.trim());
            }

            if (sizes.length > 0) {
                sizeContainer.classList.remove('hidden');
                sizeOptions.innerHTML = sizes.map(s => `
                    <button class="size-chip" onclick="selectSize(this, '${s}')">${s}</button>
                `).join('');
            } else {
                sizeContainer.classList.add('hidden');
            }

            // --- SLIDER LOGIC ---
            const slider = document.getElementById('inspectSlider');
            const sliderDots = document.getElementById('inspectSliderDots');
            
            inspectSlidesData = (p.images && p.images.length > 0) ? p.images : [p.image];
            
            // Added onclick to open zoom
            slider.innerHTML = inspectSlidesData.map(img => `
                <div class="inspect-slide premium-skeleton">
                    <img src="${img}" onclick="openZoom('${img}')" onload="this.parentElement.classList.remove('premium-skeleton')">
                </div>
            `).join('');
            
            sliderDots.innerHTML = inspectSlidesData.map((_, i) => `<div class="slider-dot ${i===0?'active':''}"></div>`).join('');
            
            updateInspectSlider();
            
            // --- DYNAMIC RATING LOGIC ---
            let avgRating = "4.8"; // Default fallback
            let reviewCount = Math.floor(Math.random() * 100) + 10;

            if (p.reviews && Array.isArray(p.reviews) && p.reviews.length > 0) {
                const total = p.reviews.reduce((sum, r) => sum + Number(r.rating || 0), 0);
                avgRating = (total / p.reviews.length).toFixed(1);
                reviewCount = p.reviews.length;
            } else {
                // If no reviews in DB, keep default or set to 0.0
                if(!p.rating) avgRating = "0.0"; // Or stick to 4.8 aesthetic default
                else avgRating = p.rating;
            }

            document.getElementById('inspectRatingValue').innerText = avgRating;
            document.getElementById('inspectReviewCount').innerText = `(${reviewCount})`;

            const reviewContainer = document.getElementById('reviewsContainer');
            if (p.reviews && p.reviews.length > 0) {
                 reviewContainer.innerHTML = p.reviews.map(r => `
                    <div class="min-w-[220px] bg-[#141414] border border-white/5 p-4 rounded-2xl flex flex-col gap-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-yellow-400 flex items-center justify-center shrink-0">
                                <i data-lucide="user" class="w-4 h-4 text-black"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-white uppercase">${r.name}</p>
                                <div class="flex items-center gap-1 mt-0.5">
                                    <i data-lucide="star" class="w-2.5 h-2.5 fill-yellow-400 text-yellow-400"></i>
                                    <span class="text-[9px] text-zinc-400 font-bold">${r.rating}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-[9px] text-zinc-500 leading-relaxed line-clamp-2">${r.text}</p>
                    </div>
                 `).join('');
            } else {
                const fakeUsernames = ["Alex M.", "Sarah K.", "John D.", "Priya S.", "Rahul V."];
                reviewContainer.innerHTML = fakeUsernames.map(name => {
                    const rating = (Math.random() * (4.9 - 3.8) + 3.8).toFixed(1);
                    return `
                    <div class="min-w-[220px] bg-[#141414] border border-white/5 p-4 rounded-2xl flex flex-col gap-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-yellow-400 flex items-center justify-center shrink-0">
                                <i data-lucide="user" class="w-4 h-4 text-black"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-white uppercase">${name}</p>
                                <div class="flex items-center gap-1 mt-0.5">
                                    <i data-lucide="star" class="w-2.5 h-2.5 fill-yellow-400 text-yellow-400"></i>
                                    <span class="text-[9px] text-zinc-400 font-bold">${rating}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-[9px] text-zinc-500 leading-relaxed line-clamp-2">Absolute masterclass in design. The build quality is unreal.</p>
                    </div>
                `}).join('');
            }

            lucide.createIcons();

            document.getElementById('inspectAddBtn').onclick = () => addToCart(p.id);
            document.getElementById('inspectLikeBtn').onclick = () => toggleWishlist(p.id);
            updateInspectLikeIcon();
            
            document.getElementById('inspectOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.selectSize = function(btn, size) {
            currentSelectedSize = size;
            // Visual feedback
            document.querySelectorAll('.size-chip').forEach(c => c.classList.remove('selected'));
            btn.classList.add('selected');
        };

        // --- ZOOM FUNCTIONS ---
        window.openZoom = function(src) {
            const overlay = document.getElementById('zoomOverlay');
            const img = document.getElementById('zoomImage');
            img.src = src;
            // Reset transform
            img.style.transform = "scale(1) translate(0px, 0px)";
            overlay.classList.add('active');
        };

        window.closeZoom = function() {
            document.getElementById('zoomOverlay').classList.remove('active');
        };

        window.moveInspectSlider = function(dir) {
            const count = inspectSlidesData.length;
            if(count === 0) return;
            currentInspectSlide = (currentInspectSlide + dir + count) % count;
            updateInspectSlider();
        };

        function updateInspectSlider() {
            const slider = document.getElementById('inspectSlider');
            slider.style.transform = `translateX(-${currentInspectSlide * 100}%)`;
            document.querySelectorAll('#inspectSliderDots .slider-dot').forEach((d, i) => {
                d.classList.toggle('active', i === currentInspectSlide);
            });
        }

        window.closeInspect = function() {
            document.getElementById('inspectOverlay').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };

        function updateInspectLikeIcon() {
            const icon = document.getElementById('inspectLikeIcon');
            if(wishlist.includes(currentInspectId)) {
                icon.classList.add('fill-red-500', 'text-red-500', 'border-red-500');
                icon.classList.remove('text-zinc-400');
            } else {
                icon.classList.remove('fill-red-500', 'text-red-500', 'border-red-500');
                icon.classList.add('text-zinc-400');
            }
        }

        window.showShippingPage = function() { showPage('shipping'); };

        // --- ADDRESS FORM ---
        function initCustomSelect() {
            const optsContainer = document.getElementById('stateOptions');
            const indianStates = ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"];
            optsContainer.innerHTML = indianStates.map(s => 
                `<div class="custom-option" onclick="selectState('${s}')">${s}</div>`
            ).join('');
        }

        window.toggleStateDropdown = function() {
            document.getElementById('stateOptions').classList.toggle('open');
        };

        window.selectState = function(state) {
            document.getElementById('selectedState').innerText = state;
            document.getElementById('stateOptions').classList.remove('open');
        };

        window.handlePincode = async function(pin) {
            const el = document.getElementById('addrPincode');
            el.value = el.value.replace(/[^0-9]/g, '');
            if(pin.length === 6) {
                try {
                    const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
                    const data = await res.json();
                    if(data[0].Status === "Success") {
                        const place = data[0].PostOffice[0];
                        document.getElementById('addrCity').value = place.Block;
                        document.getElementById('addrDistrict').value = place.District;
                        selectState(place.State);
                    }
                } catch(e) { console.error(e); }
            }
        };

        document.getElementById('addressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // FIXED: Added missing fields (area, district, altMobile) to the object creation
            const newAddr = {
                name: document.getElementById('addrName').value,
                mobile: document.getElementById('addrMobile').value,
                altMobile: document.getElementById('addrAltMobile').value,
                pincode: document.getElementById('addrPincode').value,
                house: document.getElementById('addrHouse').value,
                area: document.getElementById('addrArea').value, // <--- WAS MISSING
                city: document.getElementById('addrCity').value,
                district: document.getElementById('addrDistrict').value,
                state: document.getElementById('selectedState').innerText
            };
            
            if (newAddr.mobile.length !== 10) {
                showAlert("Invalid Mobile", "Mobile number must be 10 digits.");
                return;
            }

            // 1. UPDATE LOCAL STATE
            addresses = [newAddr]; // Overwrite current address list with new one
            appDB.save('addresses', addresses);

            // 2. SYNC TO FIREBASE REALTIME DATABASE (PERSISTENCE)
            if (currentUser && currentUser.mobile) {
                const userRef = ref(db, 'users/' + currentUser.mobile);
                update(userRef, { savedAddress: newAddr })
                    .then(() => console.log("Address synced to cloud"))
                    .catch((err) => console.error("Sync failed", err));
            }

            showAlert("Success", "Address Saved Successfully!");
            showPage('profile');
        });

        // --- PRIVACY TOGGLE LOGIC (NEW) ---
        window.togglePrivacy = function(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            
            if(content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        };
    </script>
</body>
  </html> 
